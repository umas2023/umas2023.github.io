<!DOCTYPE html>
<html lang=" en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>windows: hyperv虚拟机软路由 | umas’ awesome title</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="windows: hyperv虚拟机软路由" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="下载镜像" />
<meta property="og:description" content="下载镜像" />
<link rel="canonical" href="/windows/hyperv_openwrt/" />
<meta property="og:url" content="/windows/hyperv_openwrt/" />
<meta property="og:site_name" content="umas’ awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-09T11:57:03+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="windows: hyperv虚拟机软路由" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-09-09T11:57:03+08:00","datePublished":"2023-09-09T11:57:03+08:00","description":"下载镜像","headline":"windows: hyperv虚拟机软路由","mainEntityOfPage":{"@type":"WebPage","@id":"/windows/hyperv_openwrt/"},"url":"/windows/hyperv_openwrt/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="umas&apos; awesome title" /></head>
<body>
  <!-- 背景图 -->
  <div class="bg-img"></div><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">umas&#39; awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/categories/">Categories</a><a class="page-link" href="/search/">Search</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
    <div class="wrapper">
      <article class="post">

  <!-- 标题 -->
  <header class="post-header">
    <h1 class="post-title">windows: hyperv虚拟机软路由</h1>
    
    <!-- 分类tag -->
    
    <div class="category">windows</div>
    

    <h3>不花钱加速局域网内学习机</h3>
  </header>

  <!-- 目录 -->
  <hr>
  <ul id="toc" class="toc__list">
<li class="toc-entry toc-h2"><a href="#下载镜像">下载镜像</a></li>
<li class="toc-entry toc-h2"><a href="#启动虚拟机">启动虚拟机</a></li>
<li class="toc-entry toc-h2"><a href="#安装clash">安装clash</a></li>
<li class="toc-entry toc-h2"><a href="#windows连接">windows连接</a></li>
<li class="toc-entry toc-h2"><a href="#热点转发">热点转发</a></li>
<li class="toc-entry toc-h2"><a href="#后记">后记</a></li>
</ul>
  <hr>

  <!-- 内容主体 -->
  <div class="post-content">
    <h2 id="下载镜像">下载镜像</h2>

<ul>
  <li>下载openwrt镜像
    <ul>
      <li>https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/</li>
    </ul>
  </li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_1.png" alt="引入图片" /></p>

<ul>
  <li>combined：文件系统 + 内核</li>
  <li>
    <p>rootfs： 只有文件系统</p>
  </li>
  <li>
    <p>注意下载之后的压缩包用7z解压可能报错，可以用winrar</p>
  </li>
  <li>starwind软件将img转为vmdk
    <ul>
      <li>选localfile，VHD/VHDX，VHDX growable image</li>
    </ul>
  </li>
</ul>

<h2 id="启动虚拟机">启动虚拟机</h2>

<ul>
  <li>确认hyperv已经打开</li>
  <li>windows管理工具-&gt;hyper-v管理器</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_2.png" alt="引入图片" /></p>

<ul>
  <li>外部网络选择当前使用的网卡</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_3.png" alt="引入图片" /></p>

<ul>
  <li>创建虚拟机</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_4.png" alt="引入图片" /></p>

<ul>
  <li>第二代，不使用动态内存，连接选刚才的wrt_lan，使用现有虚拟硬盘找到刚才的vhdx</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_5.png" alt="引入图片" /></p>

<ul>
  <li>安全 -&gt; 启用安全启动 - 关掉</li>
  <li>网络适配器 -&gt; 高级功能 -&gt; 启用mac地址欺骗</li>
  <li>检查点 -&gt; 使用自动检查点 - 关掉</li>
  <li>
    <p>自动启动 -&gt; 有需要的话开启始终自动启动</p>
  </li>
  <li>右键连接openwrt，编辑</li>
  <li>Vim etc/config/network</li>
  <li>改成和当前路由器相同网段</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_6.png" alt="引入图片" /></p>

<ul>
  <li>
    <p>reboot</p>
  </li>
  <li>浏览器输入上面的ip：192.168.31.31</li>
  <li>没有密码</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_7.png" alt="引入图片" /></p>

<ul>
  <li>修改lan，网关指向主路由</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_8.png" alt="引入图片" /></p>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_9.png" alt="引入图片" /></p>

<ul>
  <li>DHCP服务器：忽略此接口</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_10.png" alt="引入图片" /></p>

<ul>
  <li>禁用桥接</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_11.png" alt="引入图片" /></p>

<ul>
  <li>Dns 8.8.8.8</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_12.png" alt="引入图片" /></p>

<ul>
  <li>
    <p>ping downloads.openwrt.org</p>
  </li>
  <li>安装中文语言包</li>
  <li>Index of /releases/22.03.5/packages/x86_64/luci/ (openwrt.org)</li>
  <li>搜base-zh-cn</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_13.png" alt="引入图片" /></p>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_14.png" alt="引入图片" /></p>

<ul>
  <li>更换阿里源</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_15.png" alt="引入图片" /></p>

<ul>
  <li>将 /etc/opkg/distfeeds.conf 下的 downloads.openwrt.org 替换为mirrors.aliyun.com/openwrt</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src/gz openwrt_core https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/packages
src/gz openwrt_base https://downloads.openwrt.org/releases/22.03.5/packages/x86_64/base
src/gz openwrt_luci https://downloads.openwrt.org/releases/22.03.5/packages/x86_64/luci
src/gz openwrt_packages https://downloads.openwrt.org/releases/22.03.5/packages/x86_64/packages
src/gz openwrt_routing https://do
</code></pre></div></div>

<ul>
  <li>
    <p>完了update一下：<code class="language-plaintext highlighter-rouge">opkg update</code></p>
  </li>
  <li>
    <p>注意第一行的targets不要改，会报错（2023.5.28）</p>
  </li>
</ul>

<h2 id="安装clash">安装clash</h2>

<ul>
  <li>
    <p>参考：https://github.com/vernesong/OpenClash/wiki/%E5%AE%89%E8%A3%85</p>
  </li>
  <li>
    <p>首先删掉dnsmasq</p>
  </li>
  <li>下载ipk</li>
  <li>Releases · vernesong/OpenClash (github.com)</li>
  <li>安装依赖</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg update
opkg install coreutils-nohup --force-overwrite
opkg install bash --force-overwrite
opkg install iptables --force-overwrite
opkg install dnsmasq-full --force-overwrite
opkg install curl --force-overwrite
opkg install ca-certificates --force-overwrite
opkg install ipset --force-overwrite
opkg install i
</code></pre></div></div>

<ul>
  <li>整合↑</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg install coreutils-nohup  bash  iptables  dnsmasq-full  curl  ca-certificates  ipset  ip-full  iptables-mod-tproxy  iptables-mod-extra  libcap  libcap-bin  ruby  ruby-yaml  kmod-tun --force-overwrite 

</code></pre></div></div>

<ul>
  <li>ipk文件拷贝到远程主机
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp .\luci-app-openclash_0.45.121-beta_all.ipk root@192.168.31.31:/root
</code></pre></div>    </div>
  </li>
  <li>opkg install
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg install luci-app-openclash_0.45.121-beta_all.ipk
</code></pre></div>    </div>
  </li>
  <li>报错 module ‘luci.cbi.datatypes’ not found
    <ul>
      <li>参考：https://github.com/vernesong/OpenClash/issues/2364</li>
      <li>参考：https://blog.csdn.net/xs18952904/article/details/124600025</li>
    </ul>
  </li>
  <li>命令报错找不到：opkg install luci-compat，需要手动下载
    <ul>
      <li>https://downloads.openwrt.org/releases/22.03.5/packages/x86_64/luci/</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp .\luci-compat_git-23.093.42303-ef4cd04_all.ipk root@192.168.31.31:/root
opkg install luci-compat_git-23.093.42303-ef4cd04_all.ipk
</code></pre></div></div>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_16.png" alt="引入图片" /></p>

<ul>
  <li>
    <p>这里没有手动下载内核，如果配置完成后内核自动下载失败，需要手动下载</p>
  </li>
  <li>
    <p>不行，它不能自动下载，还是要手动下</p>
  </li>
  <li>
    <p>下载内核，三个不存在的都下载</p>
    <ul>
      <li>md好麻烦，还是安一个winscp吧</li>
    </ul>
  </li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_17.png" alt="引入图片" /></p>

<ul>
  <li>拷过去之后加权限</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_18.png" alt="引入图片" />
<img src="/image/windows/2023-09-09-hyperv_openwrt/image_19.png" alt="引入图片" /></p>

<ul>
  <li>启用fake-ip模式（在底部点击）记得点保存应用</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_20.png" alt="引入图片" /></p>

<ul>
  <li>启动之后在 server logs 报错</li>
  <li>警告：OpenClash 启动成功，检测到您启用了IPv6的DHCP服务，可能会造成连接异常！</li>
  <li>接口编辑里关掉这个：</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_21.png" alt="引入图片" /></p>

<ul>
  <li>安装主题</li>
  <li><a href="https://github.com/jerrykuku/luci-theme-argon/blob/master/README_ZH.md">luci-theme-argon/README_ZH.md at master · jerrykuku/luci-theme-argon · GitHub</a></li>
  <li>可以用wget
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg install luci-compat
opkg install luci-lib-ipkg
wget --no-check-certificate https://github.com/jerrykuku/luci-theme-argon/releases/download/v2.3/luci-theme-argon_2.3_all.ipk
opkg install luci-theme-argon*.ipk
</code></pre></div>    </div>
  </li>
  <li>报错找不到的话update一下
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg update
</code></pre></div>    </div>
  </li>
  <li>也可以直接下载：</li>
  <li>https://github.com/jerrykuku/</li>
</ul>

<h2 id="windows连接">windows连接</h2>

<ul>
  <li>修改默认网关</li>
  <li>不需要在路由器里固定ip地址</li>
  <li>设置的网卡必须是之前open wrt连接的网卡，双网卡要选对，第三方手机不能连接</li>
  <li>首选dns是wrt地址
注意连接后需要等待2-3分钟，期间会无法联网</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_22.png" alt="引入图片" />
<img src="/image/windows/2023-09-09-hyperv_openwrt/image_23.png" alt="引入图片" /></p>

<ul>
  <li>经测试下面这个方法不太行</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_24.png" alt="引入图片" /></p>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_25.png" alt="引入图片" /></p>

<ul>
  <li>1、网络前缀长度24，对应子网掩码【255.255.255.0】；</li>
  <li>2、网络前缀长度18，对应子网掩码【255.255.240.0】；</li>
  <li>3、网络前缀长度16，对应子网掩码【255.255.0.0】</li>
</ul>

<h2 id="热点转发">热点转发</h2>

<ul>
  <li>实际测试时发现只有电脑本机可以正常上网，安卓苹果switch都不行</li>
  <li>可以将电脑的网络通过热点转发给其他设备</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_26.png" alt="引入图片" /></p>

<ul>
  <li>打开共享后可以看到多出一个网络设备</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_27.png" alt="引入图片" /></p>

<ul>
  <li>在当前电脑连接wifi的设备属性里打开共享，没有开启共享时手机连上会显示没有网络</li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_28.png" alt="引入图片" /></p>

<ul>
  <li>
    <p>补充一点，如果手机长时间连接不上的话，把上面的勾去掉试试</p>
  </li>
  <li>
    <p>如果电脑连接后可以正常上网翻墙，但右下角显示无internet，这时无法开启热点，可以尝试：</p>
    <ul>
      <li>更换节点</li>
      <li>或者关闭ipv4校验，关闭后重新启动clash并重新连接，</li>
    </ul>
  </li>
</ul>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_29.png" alt="引入图片" /></p>

<p><img src="/image/windows/2023-09-09-hyperv_openwrt/image_30.png" alt="引入图片" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code></code></pre></div></div>

<h2 id="后记">后记</h2>

<ul>
  <li>由于虚拟机性能限制，switch连接后nat无法满足联机需要</li>
  <li>加钱买了个小米路由器，刷机教程详见另一篇</li>
</ul>

  </div>

</article>


<style scoped>

div.category{
    display: inline-block;
    padding: 2px 5px 5px 5px;
    margin-bottom: 5px;
    border-radius: 5px;
    font-size: 0.5em;
    color: white;
    background-color: rgba(0, 0, 255, 0.4);
  }

</style>
    </div>
  </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">umas&#39; awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">umas&#39; awesome title</li><li><a class="u-email" href="mailto:1970313791@qq.com">1970313791@qq.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/umas2022"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">umas2022</span></a></li><li><a href="https://www.twitter.com/%28no_twitter%29"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">(no_twitter)</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>umas&#39; awesome description for his new site here. It will appear in his document head meta (for Google search results) and in his feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

<style scoped>
  /* 背景图片 */
  div.bg-img {
    background-image: url("/static/background.svg");
    position: absolute;
    height: 100%;
    width: 100%;
    background-repeat: repeat;
    background-size: 400px;
    z-index: -2;
    opacity: 0.1;
  }
</style>

</html>